$ErrorActionPreference  =   'Stop'
$ProgressPreference     =   'SilentlyContinue'



try {

    if (!(Get-AteraAPIKey)) {
        Write-Host "The Atera APIKey is not present. Requesting it now." -foregroundcolor Yellow
        Write-Host "Enter the Atera API Key and press ENTER to continue."
        $AteraAPIKey = Read-Host
        Set-AteraAPIKey $AteraAPIKey
    }

    # Use the PSAtera module to query all available customers and generate a menu.
        $Customers = Get-AteraCustomers | select CustomerID, CustomerName | sort CustomerID

    # Generate Menu
        $Output = @()
        $Output += "Atera Customer Menu:"
        $Output += "    Customer ID        Customer Name"
        $Output += "    -----------        -------------"
        $Customers | foreach {$Output += "      $($_.CustomerID)                $($_.CustomerName)"}
        $Output += ""
        $Output += "      99                All Customers"
        $Output += "      999               Exit"

    # Display Menu and prompt for selection
        while (1) {
            $Output
            Write-Host "Enter a Customer ID and press ENTER to continue."
            $Choice = Read-Host
            if ($Choice -eq 99) {
                $CustomerID = ($Customers | where {$_.CustomerID -eq $($Choice)}).CustomerID
                $CustomerName = "All Customers"
                Write-Host "You selected $($CustomerName) for $($CustomerName)"
                break;
            } elseif ($Choice -eq 999) {
                Write-Host "You selected $($Choice) for to exit. Exiting Now."
                break;
            } elseif ($Customers.CustomerID -contains $Choice) {
                $CustomerID = ($Customers | where {$_.CustomerID -eq $($Choice)}).CustomerID
                $CustomerName = ($Customers | where {$_.CustomerID -eq $($Choice)}).CustomerName
                Write-Host "You selected $($Choice) for customer $($CustomerName)"
                break;
            } else {
                Write-Host "Incorrect Value Entered! Press any key to try again"
                pause
            }
        }
} catch {
    Write-Host "An error has occurred $($_)" -ForegroundColor Red
}
